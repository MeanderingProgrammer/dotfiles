#!/usr/bin/env python

import os
import subprocess

import click


@click.group(
    context_settings=dict(
        help_option_names=["-h", "--help"],
    ),
)
def cli() -> None:
    """Improves interacting with Git PRs"""
    pass


@cli.command()
def push() -> None:
    """Push current branch as PR"""
    branch = cmd("git", "branch", "--show-current")
    print(f"pushing {branch} to origin")
    os.system(f"git push -f origin {branch}")


@cli.command()
@click.argument("id", type=int)
def pull(id: int) -> None:
    """Pull PR with ID"""
    branch = f"review-{id}"
    print(f"pulling {branch} from origin")
    os.system(f"git fetch origin 'pull/{id}/head:{branch}'")
    print(f"checking out {branch}")
    os.system(f"git checkout {branch}")


def cmd(*args: str) -> str:
    result = subprocess.run(args, capture_output=True, text=True)
    if result.returncode != 0:
        raise Exception(f"{' '.join(args)} failed: {result.stderr}")
    return result.stdout.strip()


if __name__ == "__main__":
    cli()
