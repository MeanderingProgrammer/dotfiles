#!/usr/bin/env python

import subprocess

import click


@click.group(
    context_settings=dict(
        help_option_names=["-h", "--help"],
    ),
)
def cli() -> None:
    """Improves interacting with Git PRs"""
    pass


@cli.command()
def push() -> None:
    """Push current branch as PR"""
    branch = cmd("git", "branch", "--show-current")
    print(f"pushing {branch} to origin")
    run("git", "push", "-f", "origin", branch)


@cli.command()
@click.argument("id", type=int)
def pull(id: int) -> None:
    """Pull PR with ID"""
    branch = f"review-{id}"
    print(f"pulling {branch} from origin")
    run("git", "fetch", "origin", f"pull/{id}/head:{branch}")
    print(f"checking out {branch}")
    run("git", "checkout", branch)


def cmd(*args: str) -> str:
    result = subprocess.run(args, capture_output=True, text=True)
    if result.returncode != 0:
        raise Exception(f"{' '.join(args)} failed: {result.stderr}")
    return result.stdout.strip()


def run(*args: str) -> None:
    subprocess.run(args)


if __name__ == "__main__":
    cli()
