#!/usr/bin/env python

import json
import os
import subprocess
from pathlib import Path
from typing import Any

import click


@click.group()
def cli() -> None:
    """Docker helper scripts"""
    pass


@cli.command()
def setup() -> None:
    """Perform setup"""
    config = Path(env("DOCKER_CONFIG")) / "config.json"
    assert config.is_file(), f"missing config: {config}"

    plugins = Path(env("HOMEBREW_PREFIX")) / "lib/docker/cli-plugins"
    assert plugins.is_dir(), f"missing plugins: {plugins}"

    data = json.loads(config.read_text())
    directories: list[str] = get_or_set(data, "cliPluginsExtraDirs", [])
    if str(plugins) in directories:
        print(f"skipped {config}")
    else:
        directories.append(str(plugins))
        config.write_text(json.dumps(data, indent=4))
        print(f"updated {config}")


@cli.command()
def clean() -> None:
    """Remove any untagged images"""
    untagged = True
    while untagged:
        print("getting untagged images")
        ids: list[str] = []
        lines = cmd("docker", "image", "ls", "--format", "json")
        for line in lines:
            image = json.loads(line)
            if image["Tag"] == "<none>":
                ids.append(image["ID"])

        for id in ids:
            output = cmd("docker", "rmi", "-f", id)
            print(f"untagged {id}: {output}")

        untagged = len(ids) > 0


def env(key: str) -> str:
    result = os.getenv(key)
    assert result is not None, f"missing key: {key}"
    return result


def get_or_set(data: dict[str, Any], key: str, default: Any) -> Any:
    data[key] = data.get(key, default)
    return data[key]


def cmd(*args: str) -> list[str]:
    result = subprocess.run(args, capture_output=True, text=True)
    if result.returncode != 0:
        raise Exception(f"{' '.join(args)} failed: {result.stderr}")
    return result.stdout.splitlines()


if __name__ == "__main__":
    cli()
