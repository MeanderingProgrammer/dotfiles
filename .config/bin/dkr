#!/usr/bin/env python

import json
import subprocess

import click


@click.group()
def cli() -> None:
    """Docker helper scripts"""
    pass


@cli.command()
def clean() -> None:
    """Remove any untagged images"""

    untagged = True
    while untagged:
        print("getting untagged images")
        ids: list[str] = []
        lines = run(["docker", "image", "ls", "--format", "json"])
        for line in lines:
            image = json.loads(line)
            if image["Tag"] == "<none>":
                ids.append(image["ID"])

        for id in ids:
            output = run(["docker", "rmi", "-f", id])
            print(f"untagged {id}: {output}")

        untagged = len(ids) > 0


def run(cmd: list[str]) -> list[str]:
    result = subprocess.run(cmd, capture_output=True, text=True)
    if result.returncode != 0:
        raise Exception(f"{' '.join(cmd)} failed: {result.stderr.strip()}")
    return result.stdout.splitlines()


if __name__ == "__main__":
    cli()
