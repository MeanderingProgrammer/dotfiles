#!/usr/bin/env python
# PYTHON_ARGCOMPLETE_OK

import subprocess
from argparse import ArgumentParser

import argcomplete


class Asdf:
    """
    https://asdf-vm.com/manage/commands.html
    """

    def plugins(self) -> list[str]:
        result: str = Asdf.run(["asdf", "current"])
        plugins: list[str] = [plugin.split()[0] for plugin in result.splitlines()]
        # Some plugins have complex version names so latest is not supported
        for plugin in ["java"]:
            plugins.remove(plugin)
        return plugins

    def current(self, name: str) -> str:
        result: str = Asdf.run(["asdf", "current", name])
        return result.split()[1]

    def latest(self, name: str) -> str:
        return Asdf.run(["asdf", "latest", name])

    def install(self, name: str, version: str) -> None:
        Asdf.run(["asdf", "install", name, version])

    def set_global(self, name: str, version: str) -> None:
        Asdf.run(["asdf", "global", name, version])

    def uninstall(self, name: str, version: str) -> None:
        Asdf.run(["asdf", "uninstall", name, version])

    @staticmethod
    def run(command: list[str]) -> str:
        result = subprocess.run(command, capture_output=True, text=True)
        if result.returncode == 0:
            return result.stdout.strip()
        else:
            raise Exception(f"{command} failed with {result.stderr.strip()}")


def main(name: str) -> None:
    asdf = Asdf()
    if name == "all":
        plugins: list[str] = asdf.plugins()
    else:
        plugins: list[str] = [name]
    for plugin in plugins:
        update_plugin(asdf, plugin)


def update_plugin(asdf: Asdf, name: str) -> None:
    current: str = asdf.current(name)
    latest: str = asdf.latest(name)
    if current == latest:
        print(f"{name} is already at latest version {latest}")
        return

    upgrade: bool = get_user_input(f"Upgrade {name} from {current} to {latest}?")
    if not upgrade:
        print("Aborting")
        return

    cleanup: bool = get_user_input(f"Uninstall {name} version {current}?")

    print(f"Installing {name} {latest}")
    asdf.install(name, latest)
    print(f"Setting {name} to {latest}")
    asdf.set_global(name, latest)

    if cleanup:
        print(f"Uninstalling {name} {current}")
        asdf.uninstall(name, current)


def get_user_input(prompt: str) -> bool:
    answer = input(f"{prompt} [y]es or [n]o: ")
    if answer.lower() in ["y", "yes"]:
        return True
    elif answer.lower() in ["n", "no"]:
        return False
    else:
        print(f"Invalid value: {answer}")
        return get_user_input(prompt)


if __name__ == "__main__":
    parser = ArgumentParser(description="Interactive update script for asdf plugins")
    parser.add_argument(
        "name", choices=Asdf().plugins() + ["all"], help="Name of plugin to update"
    )
    argcomplete.autocomplete(parser)
    args = parser.parse_args()
    main(args.name)
